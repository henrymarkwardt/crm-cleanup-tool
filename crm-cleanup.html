<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM Cleanup Tool</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f0f2f5;
    color: #1a1a2e;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ UPLOAD SCREEN ‚îÄ‚îÄ */
  #upload-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
  }

  .upload-card {
    background: white;
    border-radius: 16px;
    padding: 3rem;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    text-align: center;
  }

  .upload-card h1 {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #1a1a2e;
  }

  .upload-card p {
    color: #666;
    margin-bottom: 2rem;
    font-size: 0.95rem;
  }

  .file-drop {
    border: 2px dashed #d0d5dd;
    border-radius: 12px;
    padding: 2.5rem 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 1rem;
  }

  .file-drop:hover, .file-drop.dragover {
    border-color: #4f6ef7;
    background: #f5f7ff;
  }

  .file-drop svg { margin-bottom: 0.75rem; }

  .file-drop p {
    margin: 0;
    color: #555;
    font-size: 0.9rem;
  }

  .file-drop strong { color: #4f6ef7; }

  #file-input { display: none; }

  .resume-banner {
    background: #fff8e1;
    border: 1px solid #ffe082;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    margin-top: 1.25rem;
    text-align: left;
  }

  .resume-banner p { color: #5c4000; font-size: 0.9rem; margin-bottom: 0.75rem; }

  .btn-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }

  .btn {
    padding: 0.65rem 1.25rem;
    border-radius: 8px;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-primary { background: #4f6ef7; color: white; }
  .btn-primary:hover { background: #3a59e8; }
  .btn-secondary { background: #f0f2f5; color: #333; }
  .btn-secondary:hover { background: #e2e6ea; }
  .btn-danger { background: #ff4757; color: white; }
  .btn-danger:hover { background: #e63946; }
  .btn-success { background: #2ed573; color: #1a1a2e; }
  .btn-success:hover { background: #26c265; }
  .btn-warning { background: #ffa502; color: white; }
  .btn-warning:hover { background: #e5940a; }

  /* ‚îÄ‚îÄ EDIT SCREEN ‚îÄ‚îÄ */
  #edit-screen { display: none; padding: 1.5rem; max-width: 900px; margin: 0 auto; }

  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .progress-info h2 { font-size: 1.1rem; font-weight: 700; color: #1a1a2e; }
  .progress-info p { font-size: 0.85rem; color: #666; margin-top: 2px; }

  .progress-bar-wrap {
    width: 100%;
    height: 6px;
    background: #e2e6ea;
    border-radius: 3px;
    margin-top: 0.5rem;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: #4f6ef7;
    border-radius: 3px;
    transition: width 0.3s;
  }

  .top-actions { display: flex; gap: 0.6rem; flex-wrap: wrap; }

  .card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    margin-bottom: 1rem;
  }

  .card-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #888;
    margin-bottom: 1rem;
  }

  .essential-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.85rem;
  }

  .field-group { display: flex; flex-direction: column; }

  .field-group label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #555;
    margin-bottom: 0.3rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .field-group input, .field-group textarea, .field-group select {
    padding: 0.55rem 0.75rem;
    border: 1.5px solid #d0d5dd;
    border-radius: 7px;
    font-size: 0.9rem;
    font-family: inherit;
    transition: border-color 0.15s, background 0.15s;
    background: white;
    color: #1a1a2e;
    resize: vertical;
  }

  .field-group input:focus, .field-group textarea:focus, .field-group select:focus {
    outline: none;
    border-color: #4f6ef7;
  }

  .field-group input.empty, .field-group textarea.empty, .field-group select.empty {
    border-color: #ff4757;
    background: #fff5f6;
  }

  .field-group input.autofilled, .field-group textarea.autofilled {
    border-color: #ffa502;
    background: #fffbf0;
  }

  /* search links row */
  .search-links {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.15s;
  }

  .link-google {
    background: #f0f2f5;
    color: #333;
    border: 1px solid #d0d5dd;
  }
  .link-google:hover { background: #e2e6ea; }

  .link-chatgpt {
    background: #10a37f;
    color: white;
  }
  .link-chatgpt:hover { background: #0d8a6b; }

  /* remaining fields */
  .fields-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.85rem;
  }

  .section-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #bbb;
    margin: 0.75rem 0 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #eee;
  }

  .action-bar .btn { padding: 0.75rem 1.75rem; font-size: 1rem; }

  /* ‚îÄ‚îÄ DONE SCREEN ‚îÄ‚îÄ */
  #done-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
  }

  .done-card {
    background: white;
    border-radius: 16px;
    padding: 3rem;
    max-width: 480px;
    width: 100%;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    text-align: center;
  }

  .done-card h1 { font-size: 2rem; margin-bottom: 0.5rem; }
  .done-card p { color: #666; margin-bottom: 1.5rem; }
  .done-card .btn { margin: 0.4rem; }

  .empty-badge {
    display: inline-block;
    background: #ff4757;
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 0.15rem 0.45rem;
    border-radius: 4px;
    margin-left: 0.4rem;
    vertical-align: middle;
  }

  .dropdown-hint {
    font-size: 0.72rem;
    color: #999;
    margin-top: 0.25rem;
  }

  /* directions box */
  .directions {
    background: #f5f7ff;
    border: 1px solid #c7d0fa;
    border-radius: 10px;
    padding: 1.1rem 1.25rem;
    margin-top: 1.5rem;
    text-align: left;
  }
  .directions h3 { font-size: 0.85rem; font-weight: 700; color: #4f6ef7; margin-bottom: 0.6rem; }
  .directions ol { padding-left: 1.2rem; }
  .directions li { font-size: 0.82rem; color: #555; margin-bottom: 0.35rem; line-height: 1.45; }
  .directions li strong { color: #1a1a2e; }

  /* modal overlay */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal-box {
    background: white;
    border-radius: 14px;
    padding: 2rem;
    max-width: 420px;
    width: 90%;
    box-shadow: 0 8px 40px rgba(0,0,0,0.18);
    text-align: center;
  }
  .modal-box h2 { font-size: 1.2rem; margin-bottom: 0.75rem; }
  .modal-box p { font-size: 0.9rem; color: #555; line-height: 1.55; margin-bottom: 1.25rem; }
  .modal-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }

  /* tag field in search links */
  .tag-group {
    display: flex;
    flex-direction: column;
  }
  .tag-group label {
    font-size: 0.72rem;
    font-weight: 700;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    margin-bottom: 0.25rem;
  }
  .tag-group .tag-hint {
    font-size: 0.7rem;
    color: #999;
    margin-top: 0.2rem;
  }
  .tag-group input {
    padding: 0.5rem 0.75rem;
    border: 1.5px solid #d0d5dd;
    border-radius: 7px;
    font-size: 0.88rem;
    font-family: inherit;
    width: 220px;
  }
  .tag-group input:focus { outline: none; border-color: #4f6ef7; }

  /* action bar */
  .action-bar {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    justify-content: flex-end;
    margin-top: 1.25rem;
    flex-wrap: wrap;
    position: sticky;
    bottom: 1rem;
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UPLOAD SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="upload-screen">
  <div class="upload-card">
    <h1>CRM Cleanup Tool</h1>
    <p>Upload your master CRM CSV to start filling in missing information.</p>

    <div class="file-drop" id="file-drop" onclick="document.getElementById('file-input').click()">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#4f6ef7" stroke-width="1.5">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      <p><strong>Click to upload</strong> or drag & drop</p>
      <p style="margin-top:4px;font-size:0.8rem;color:#aaa;">CSV files only</p>
    </div>
    <input type="file" id="file-input" accept=".csv">

    <div class="directions">
      <h3>How it works</h3>
      <ol>
        <li>Upload your <strong>Master CRM CSV</strong> file above.</li>
        <li>The tool will find every row with missing information and show them to you one at a time.</li>
        <li><strong>Red fields</strong> are empty ‚Äî fill them in if you can. Other fields are editable too.</li>
        <li>Use the <strong>Google / LinkedIn</strong> link to look the person up, or <strong>Ask ChatGPT</strong> to have AI find the missing fields for you automatically.</li>
        <li>Click <strong>Save &amp; Continue</strong> to save changes and move to the next person, or <strong>Skip</strong> to move on without saving.</li>
        <li><strong>Important:</strong> Click <strong>Download CSV</strong> periodically to save your progress as a file. Save &amp; Continue only keeps changes in your browser ‚Äî if you close the tab without downloading, you may lose progress.</li>
        <li>Use the <strong>TAG</strong> field (bottom of each row) to note someone who might know more about this contact.</li>
      </ol>
    </div>

    <div class="resume-banner" id="resume-banner" style="display:none">
      <p id="resume-text"></p>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="resumeSession()">Resume Session</button>
        <button class="btn btn-secondary" onclick="startFresh()">Start Fresh</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WARNING MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="warning-modal">
  <div class="modal-box">
    <div class="modal-icon">‚ö†Ô∏è</div>
    <h2>Important: Save your work!</h2>
    <p>
      <strong>Save &amp; Continue</strong> only keeps your changes in the browser (localStorage).<br><br>
      To actually save your progress as a file, you <strong>must click "Download CSV"</strong> in the top right. If you close this tab without downloading, any unsaved changes could be lost.
    </p>
    <button class="btn btn-primary" style="width:100%" onclick="closeWarning()">Got it, let's go</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="edit-screen">
  <div class="top-bar">
    <div class="progress-info">
      <h2 id="progress-title">Reviewing incomplete rows</h2>
      <p id="progress-sub"></p>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn btn-warning" onclick="downloadCSV()">‚¨á Download CSV</button>
      <button class="btn btn-secondary" onclick="goToUpload()">‚Ü© New File</button>
    </div>
  </div>

  <!-- Essential Info -->
  <div class="card">
    <div class="card-title">Essential Information</div>
    <div class="essential-grid" id="essential-fields"></div>
  </div>

  <!-- Search links -->
  <div class="card" style="padding: 1rem 1.5rem;">
    <div class="search-links">
      <span style="font-size:0.82rem;color:#888;font-weight:600;">Find online:</span>
      <a id="google-link" href="#" target="_blank" class="search-link link-google">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Google / LinkedIn
      </a>
      <a id="chatgpt-link" href="#" target="_blank" class="search-link link-chatgpt">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Ask ChatGPT to fill missing fields
      </a>
    </div>
  </div>

  <!-- Remaining fields -->
  <div class="card">
    <div class="card-title">All Fields</div>
    <div id="remaining-fields"></div>
  </div>

  <!-- Action bar -->
  <div class="action-bar">
    <button class="btn btn-secondary" onclick="skipRow()">Skip</button>
    <button class="btn btn-primary" style="min-width:160px" onclick="saveAndContinue()">Save &amp; Continue ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DONE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="done-screen">
  <div class="done-card">
    <h1>üéâ All Done!</h1>
    <p id="done-text">You've reviewed all incomplete rows.</p>
    <br>
    <button class="btn btn-success" onclick="downloadCSV()" style="display:block;width:100%;margin:0 0 0.75rem">‚¨á Download Final CSV</button>
    <button class="btn btn-secondary" onclick="goToUpload()" style="display:block;width:100%">‚Ü© Upload Another File</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CSV PARSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseCSV(text) {
  const rows = [];
  let i = 0, len = text.length;
  while (i < len) {
    const row = [];
    while (i < len) {
      if (text[i] === '"') {
        // quoted field
        i++;
        let field = '';
        while (i < len) {
          if (text[i] === '"') {
            if (text[i+1] === '"') { field += '"'; i += 2; }
            else { i++; break; }
          } else {
            field += text[i++];
          }
        }
        row.push(field);
      } else {
        let field = '';
        while (i < len && text[i] !== ',' && text[i] !== '\n' && text[i] !== '\r') {
          field += text[i++];
        }
        row.push(field);
      }
      if (i < len && text[i] === ',') { i++; continue; }
      break;
    }
    // skip line endings
    if (i < len && text[i] === '\r') i++;
    if (i < len && text[i] === '\n') i++;
    if (row.length > 0 && !(row.length === 1 && row[0] === '')) rows.push(row);
  }
  return rows;
}

function buildCSV(rows) {
  return rows.map(row =>
    row.map(val => {
      const s = String(val ?? '');
      if (s.includes(',') || s.includes('"') || s.includes('\n') || s.includes('\r')) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }).join(',')
  ).join('\r\n');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  filename: '',
  headers: [],
  rows: [],          // array of objects {colName: value}
  incompleteIdxs: [], // indices into rows[] that had missing fields
  cursor: 0,         // position in incompleteIdxs
  savedCount: 0
};

const ESSENTIAL = ['First Name', 'Last Name', 'Email', 'LinkedIn', 'Investor Type  (Individual, RIA, B/D, VC, FO)', 'Organization', 'SME', 'TAG'];

const PERSONAL_DOMAINS = new Set(['gmail.com','yahoo.com','outlook.com','hotmail.com','icloud.com','aol.com','me.com','live.com','msn.com','protonmail.com','proton.me','mail.com','ymail.com','googlemail.com']);

function getEmailDomain(emailCell) {
  if (!emailCell) return null;
  for (const part of emailCell.split(',')) {
    const e = part.trim();
    if (e.includes('@')) {
      const domain = e.split('@')[1].toLowerCase().trim();
      return domain;
    }
  }
  return null;
}

function isPersonalEmail(emailCell) {
  const domain = getEmailDomain(emailCell);
  if (!domain) return null;
  return PERSONAL_DOMAINS.has(domain);
}

function getCompanyFromEmail(emailCell) {
  const domain = getEmailDomain(emailCell);
  if (!domain) return null;
  if (PERSONAL_DOMAINS.has(domain)) return null;
  // strip TLD: take first segment
  const parts = domain.split('.');
  return parts[0];
}

function rowHasMissing(rowObj, headers) {
  // Skip auto-derived cols from missing check
  const SKIP = new Set(['Personal or Work Email', 'Investor Y/N', 'TAG']);
  for (const h of headers) {
    if (SKIP.has(h)) continue;
    if (!rowObj[h] || rowObj[h].trim() === '') return true;
  }
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPLOAD HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fileInput = document.getElementById('file-input');
const fileDrop  = document.getElementById('file-drop');

fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('dragover'); });
fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('dragover'));
fileDrop.addEventListener('drop', e => {
  e.preventDefault();
  fileDrop.classList.remove('dragover');
  const f = e.dataTransfer.files[0];
  if (f) handleFile(f);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) handleFile(fileInput.files[0]);
});

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const parsed = parseCSV(text);
    if (parsed.length < 2) { alert('CSV appears empty or invalid.'); return; }

    const headers = parsed[0];
    const rows = parsed.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, i) => { obj[h] = r[i] ?? ''; });
      return obj;
    });

    state.filename = file.name;
    state.headers = headers;

    // Check localStorage for saved progress
    const saved = localStorage.getItem('crm_' + file.name);
    if (saved) {
      try {
        const data = JSON.parse(saved);
        const banner = document.getElementById('resume-banner');
        const text2 = document.getElementById('resume-text');
        text2.textContent = `Found saved progress: ${data.savedCount} rows saved, cursor at position ${data.cursor} of ${data.incompleteIdxs.length} incomplete rows.`;
        banner.style.display = 'block';
        // Store parsed for fresh start option
        window._freshRows = rows;
        window._savedData = data;
        return;
      } catch(err) {}
    }

    state.rows = rows;
    state.incompleteIdxs = rows.map((r,i) => rowHasMissing(r, headers) ? i : -1).filter(i => i >= 0);
    state.cursor = 0;
    state.savedCount = 0;
    startEditing();
  };
  reader.readAsText(file);
}

function resumeSession() {
  const data = window._savedData;
  state.rows = data.rows;
  state.incompleteIdxs = data.incompleteIdxs;
  state.cursor = data.cursor;
  state.savedCount = data.savedCount;
  hideBanner();
  startEditing();
}

function startFresh() {
  state.rows = window._freshRows;
  state.incompleteIdxs = state.rows.map((r,i) => rowHasMissing(r, state.headers) ? i : -1).filter(i => i >= 0);
  state.cursor = 0;
  state.savedCount = 0;
  localStorage.removeItem('crm_' + state.filename);
  hideBanner();
  startEditing();
}

function hideBanner() {
  document.getElementById('resume-banner').style.display = 'none';
}

function goToUpload() {
  document.getElementById('upload-screen').style.display = 'flex';
  document.getElementById('edit-screen').style.display = 'none';
  document.getElementById('done-screen').style.display = 'none';
  // reset file input
  fileInput.value = '';
  document.getElementById('resume-banner').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDITING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startEditing() {
  document.getElementById('upload-screen').style.display = 'none';
  document.getElementById('done-screen').style.display = 'none';
  document.getElementById('edit-screen').style.display = 'block';
  // Show warning modal once per session
  if (!sessionStorage.getItem('warned')) {
    document.getElementById('warning-modal').classList.add('active');
    sessionStorage.setItem('warned', '1');
  }
  renderRow();
}

function closeWarning() {
  document.getElementById('warning-modal').classList.remove('active');
}

function renderRow() {
  if (state.cursor >= state.incompleteIdxs.length) {
    showDone();
    return;
  }

  const total = state.incompleteIdxs.length;
  const current = state.cursor + 1;
  const pct = Math.round((state.cursor / total) * 100);

  document.getElementById('progress-title').textContent = `Reviewing Incomplete Rows`;
  document.getElementById('progress-sub').textContent = `${current} of ${total} ‚Äî ${state.savedCount} saved`;
  document.getElementById('progress-fill').style.width = pct + '%';

  const rowIdx = state.incompleteIdxs[state.cursor];
  const row = state.rows[rowIdx];

  renderEssential(row);
  renderSearchLinks(row);
  renderRemaining(row);
}

function renderEssential(row) {
  const container = document.getElementById('essential-fields');
  container.innerHTML = '';

  // Normalize header lookup
  const normalizedHeaders = state.headers.reduce((acc, h) => {
    acc[h.trim()] = h;
    return acc;
  }, {});

  const essentialMapped = ESSENTIAL.map(e => {
    // Try exact match first, then normalized
    if (state.headers.includes(e)) return e;
    const match = state.headers.find(h => h.trim() === e.trim());
    return match || e;
  });

  essentialMapped.forEach(colKey => {
    const val = row[colKey] ?? '';
    const isEmpty = !val || val.trim() === '';
    const isTagField = colKey === 'TAG';
    const fg = document.createElement('div');
    fg.className = 'field-group';

    // Label
    const label = document.createElement('label');
    if (isTagField) {
      label.textContent = 'Tag (tag this with someone who may know this person)';
    } else {
      label.textContent = colKey.replace(/\s*\n\s*/g, ' ').replace(/\s{2,}/g, ' ').trim();
      if (isEmpty) {
        const badge = document.createElement('span');
        badge.className = 'empty-badge';
        badge.textContent = 'EMPTY';
        label.appendChild(badge);
      }
    }
    fg.appendChild(label);

    // Dropdown for known enum fields
    const enumOptions = getEnumOptions(colKey);
    let input;
    if (enumOptions) {
      input = document.createElement('select');
      input.className = isEmpty ? 'empty' : '';
      const blank = document.createElement('option');
      blank.value = ''; blank.textContent = '‚Äî select ‚Äî';
      input.appendChild(blank);
      enumOptions.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt; o.textContent = opt;
        if (val === opt) o.selected = true;
        input.appendChild(o);
      });
      if (!isEmpty) input.value = val;
      input.addEventListener('change', () => {
        row[colKey] = input.value;
        input.className = input.value.trim() === '' ? 'empty' : '';
      });
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.value = val;
      if (isTagField) {
        input.placeholder = 'Ex: Dexter';
        input.className = ''; // Never red for TAG
      } else {
        input.className = isEmpty ? 'empty' : '';
      }
      input.addEventListener('input', () => {
        row[colKey] = input.value;
        if (!isTagField) {
          input.className = input.value.trim() === '' ? 'empty' : '';
        }
      });
    }
    input.dataset.col = colKey;
    fg.appendChild(input);
    container.appendChild(fg);
  });
}

function renderSearchLinks(row) {
  const firstName = (row['First Name'] || '').trim();
  const lastName  = (row['Last Name']  || '').trim();
  const email     = (row['Email']      || '').trim();
  const company   = getCompanyFromEmail(email) || '';

  const query = [firstName, lastName, company, 'linkedin'].filter(Boolean).join(' ');
  const googleUrl = 'https://www.google.com/search?q=' + encodeURIComponent(query);

  // Build missing fields list for ChatGPT
  const SKIP_COLS = new Set(['Personal or Work Email', 'Investor Y/N', 'TAG', 'Trusted (Y/N)']);
  const missingFields = state.headers.filter(h => !SKIP_COLS.has(h) && (!row[h] || row[h].trim() === ''));

  let chatgptPrompt = '';
  if (missingFields.length > 0) {
    const companyPart = company ? ` at ${company}` : '';
    chatgptPrompt =
      `I'm building a CRM and need help filling in missing information for a contact.\n\n` +
      `Person: ${firstName} ${lastName}${companyPart}\n` +
      `Please search LinkedIn for this person (Google: "${query}") and help me find the following missing fields:\n` +
      missingFields.map(f => `- ${f.replace(/\s*\n\s*/g,' ').replace(/\s{2,}/g,' ').trim()}`).join('\n') +
      `\n\nPlease return just the field names and values in a simple list. If you can't find a value, say "unknown".`;
  } else {
    chatgptPrompt = `Search LinkedIn for ${firstName} ${lastName}${company ? ' at ' + company : ''} and confirm their details.`;
  }

  document.getElementById('google-link').href = googleUrl;
  document.getElementById('chatgpt-link').href = 'https://chatgpt.com/?q=' + encodeURIComponent(chatgptPrompt);
}

function renderRemaining(row) {
  const container = document.getElementById('remaining-fields');
  container.innerHTML = '';

  const essentialSet = new Set(
    ESSENTIAL.map(e => state.headers.find(h => h.trim() === e.trim()) || e)
  );
  const SKIP_IN_REMAINING = new Set(['Personal or Work Email']);

  const remaining = state.headers.filter(h => !essentialSet.has(h) && !SKIP_IN_REMAINING.has(h));

  // Sort: empty first, then filled
  const empty = remaining.filter(h => !row[h] || row[h].trim() === '');
  const filled = remaining.filter(h => row[h] && row[h].trim() !== '');

  if (empty.length > 0) {
    addSectionLabel(container, `Empty fields (${empty.length})`);
    const grid = document.createElement('div');
    grid.className = 'fields-grid';
    empty.forEach(col => grid.appendChild(buildFieldGroup(col, row, true)));
    container.appendChild(grid);
  }

  if (filled.length > 0) {
    addSectionLabel(container, `Filled fields (${filled.length})`);
    const grid = document.createElement('div');
    grid.className = 'fields-grid';
    filled.forEach(col => grid.appendChild(buildFieldGroup(col, row, false)));
    container.appendChild(grid);
  }
}

function addSectionLabel(container, text) {
  const el = document.createElement('div');
  el.className = 'section-label';
  el.textContent = text;
  container.appendChild(el);
}

function buildFieldGroup(colKey, row, isEmpty) {
  const val = row[colKey] ?? '';
  const fg = document.createElement('div');
  fg.className = 'field-group';

  const label = document.createElement('label');
  const displayName = colKey.replace(/\s*\n\s*/g, ' ').replace(/\s{2,}/g, ' ').trim();
  label.textContent = displayName;
  if (isEmpty) {
    const badge = document.createElement('span');
    badge.className = 'empty-badge';
    badge.textContent = 'EMPTY';
    label.appendChild(badge);
  }
  fg.appendChild(label);

  const enumOptions = getEnumOptions(colKey);
  let input;
  if (enumOptions) {
    input = document.createElement('select');
    input.className = isEmpty ? 'empty' : '';
    const blank = document.createElement('option');
    blank.value = ''; blank.textContent = '‚Äî select ‚Äî';
    input.appendChild(blank);
    enumOptions.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt; o.textContent = opt;
      if (val === opt) o.selected = true;
      input.appendChild(o);
    });
    if (!isEmpty) input.value = val;
    const hint = document.createElement('div');
    hint.className = 'dropdown-hint';
    hint.textContent = enumOptions.join(', ');
    fg.appendChild(input);
    fg.appendChild(hint);
    input.addEventListener('change', () => {
      row[colKey] = input.value;
      input.className = input.value.trim() === '' ? 'empty' : '';
    });
    return fg;
  } else if (isLongText(colKey)) {
    input = document.createElement('textarea');
    input.rows = 2;
    input.value = val;
    input.className = isEmpty ? 'empty' : '';
    input.addEventListener('input', () => {
      row[colKey] = input.value;
      input.className = input.value.trim() === '' ? 'empty' : '';
    });
  } else {
    input = document.createElement('input');
    input.type = 'text';
    input.value = val;
    input.className = isEmpty ? 'empty' : '';
    input.addEventListener('input', () => {
      row[colKey] = input.value;
      input.className = input.value.trim() === '' ? 'empty' : '';
    });
  }
  input.dataset.col = colKey;
  fg.appendChild(input);
  return fg;
}

function getEnumOptions(colKey) {
  const k = colKey.replace(/\s+/g, ' ').trim().toLowerCase();
  if (k.includes('investor type')) return ['Individual','RIA','B/D','VC','FO','Angel','Family Office'];
  if (k.includes('investment type')) return ['Langar','LGHT','Both','NA'];
  if (k.includes('engagement')) return ['Interested','Passed','Sent to MK','Invested','Viewed DocSend','Diligence'];
  if (k === 'investor y/n') return ['Y','N'];
  if (k === 'trusted (y/n)') return ['Y','N'];
  if (k === 'hq state') return ['Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming','Washington D.C.'];
  return null;
}

function isLongText(colKey) {
  const k = colKey.toLowerCase();
  return k.includes('notes') || k.includes('breakdown') || k.includes('engagement') || k.includes('next action');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE / SKIP / DOWNLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveAndContinue() {
  const rowIdx = state.incompleteIdxs[state.cursor];
  const row = state.rows[rowIdx];

  // Auto-derive Personal or Work Email
  const email = row['Email'] || '';
  if (email) {
    const personal = isPersonalEmail(email);
    if (personal === true) row['Personal or Work Email'] = 'P';
    else if (personal === false) row['Personal or Work Email'] = 'W';
  }

  state.savedCount++;
  state.cursor++;
  saveToLocalStorage();
  renderRow();
}

function skipRow() {
  state.cursor++;
  renderRow();
}

function saveToLocalStorage() {
  const data = {
    rows: state.rows,
    incompleteIdxs: state.incompleteIdxs,
    cursor: state.cursor,
    savedCount: state.savedCount
  };
  try {
    localStorage.setItem('crm_' + state.filename, JSON.stringify(data));
  } catch(e) {
    // localStorage quota exceeded - silent fail
  }
}

function downloadCSV() {
  const csvRows = [state.headers];
  state.rows.forEach(row => {
    csvRows.push(state.headers.map(h => row[h] ?? ''));
  });
  const csvText = buildCSV(csvRows);
  const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const base = state.filename.replace(/\.csv$/i, '');
  a.download = base + '_updated.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function showDone() {
  document.getElementById('edit-screen').style.display = 'none';
  document.getElementById('done-screen').style.display = 'flex';
  document.getElementById('done-text').textContent =
    `You reviewed all ${state.incompleteIdxs.length} incomplete rows and saved ${state.savedCount} of them. Download your completed CSV below.`;
  localStorage.removeItem('crm_' + state.filename);
}
</script>
</body>
</html>
